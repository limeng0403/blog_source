<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>my theme</title>
  <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.min.css">
  <link type="text/css" href="/css/index.css" rel="stylesheet" />
</head>
<style type="text/css">

</style>
<body>
  <div class="container-fluid">
    <div class="row">
    <div class="col-sm-12">
        <div class="row box-wrapper">
            <div class="col-sm-2 box-date">
                <p>18</p>
                <p>07/2015</p>
            </div>
            <div class="col-sm-10 box-content">
                <h3>
                  <a href="/2015/07/18/mongodb3.03开启认证/" target="_blank">
                    mongodb3.03开启认证
                  </a>
                </h3>

                <p>
                  
                      database
                  
                      mongodb
                  
                </p>

                <p>下载了最新mongodb3.03版本，当使用–auth 参数命令行开启mongodb用户认证时遇到很多问题，现总结如下：</p>
<p>（百度上搜到的基本都是老版本的，看到db.addUser的就是，请忽略） </p>
<p>Windows下我做了一个bat文件，用来启动mongodb，命令行如下： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mongod --dbpath db\data --port 27017 --directoryperdb --logpath db\logs\mongodb.log --logappend --auth</span><br></pre></td></tr></table></figure>
<p>最后的参数就是开启和关闭认证，如果是conf配置文件，应该是auth=true或false </p>
<p>1、首先关闭认证，也就是不带–auth参数，启动mongodb </p>
<p>2、使用命令行进入mongodb目录，输入mongo命令，默认进入test数据库 </p>
<p>3、use userdb  切换到自己的数据库，输入db，显示userdb </p>
<p>4、创建用户，角色为dbOwner，数据库为userdb，命令行应该是db.createUser({user:’myuser’,pwd:’123456’,roles:[{role:’dbOwner’,db:’userdb’}]}) </p>
<p>5、切换到admin数据库，use admin，db，显示admin，db.shutdownServer()关闭服务器，填上认证参数，启动mongodb；以前的版本此时使用mongovue就可以使用myuser登录到userdb数据库上了，但是3.0.3版本不行，打开mongodb.log文件发现如下错误 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">authenticate db: userdb &#123; authenticate: 1, nonce: &quot;xxx&quot;, user: &quot;myuser&quot;, key: &quot;xxx&quot; &#125; </span><br><span class="line">2015-06-02T09:57:18.877+0800 I ACCESS   [conn2] Failed to authenticate myuser@userdb with mechanism MONGODB-CR: AuthenticationFailed MONGODB-CR credentials missing in the user document</span><br></pre></td></tr></table></figure>
<p>此1-5步骤针对是3.0.3以前版本已经ok，如果是3.0.3，mongodb加入了SCRAM-SHA-1校验方式，需要第三方工具配合进行验证，下面给出具体解决办法： </p>
<p>首先关闭认证，修改system.version文档里面的authSchema版本为3，初始安装时候应该是5，命令行如下： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&gt; use admin </span><br><span class="line">switched to db admin </span><br><span class="line">&gt;  var schema = db.system.version.findOne(&#123;&quot;_id&quot; : &quot;authSchema&quot;&#125;) </span><br><span class="line">&gt; schema.currentVersion = 3 </span><br><span class="line">3 </span><br><span class="line">&gt; db.system.version.save(schema) </span><br><span class="line">WriteResult(&#123; &quot;nMatched&quot; : 1, &quot;nUpserted&quot; : 0, &quot;nModified&quot; : 1 &#125;)</span><br></pre></td></tr></table></figure>
<p>不过如果你现在开启认证，仍然会提示AuthenticationFailed MONGODB-CR credentials missing in the user document 原因是原来创建的用户已经使用了SCRAM-SHA-1认证方式 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; use admin </span><br><span class="line">switched to db admin </span><br><span class="line">&gt; db.system.users.find() </span><br><span class="line">[...] </span><br><span class="line">&#123; &quot;_id&quot; : &quot;userdb.myuser&quot;, &quot;user&quot; : &quot;myuser&quot;, &quot;db&quot; : &quot;userdb&quot;, &quot;credentials&quot; : &#123; &quot;SCRAM-SHA-1&quot; : &#123; &quot;iterationCount&quot; : 10000, &quot;salt&quot; : &quot;XXXXXXXXXXXXXXXXXXXXXXXX&quot;, &quot;storedKey&quot; : &quot;XXXXXXXXXXXXXXXXXXXXXXXXXXX&quot;, &quot;serverKey&quot; : &quot;XXXXXXXXXXXXXXXXXXXXXXXXXXX&quot; &#125; &#125;, &quot;roles&quot; : [ &#123; &quot;role&quot; : &quot;dbOwner&quot;, &quot;db&quot; : &quot;userdb&quot; &#125; ] &#125;</span><br></pre></td></tr></table></figure>
<p>解决方式就是删除刚刚创建的用户，重新重建即可： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; use userdb </span><br><span class="line">switched to db userdb </span><br><span class="line">&gt; db.dropUser(&quot;myuser&quot;) </span><br><span class="line">true </span><br><span class="line">&gt;db.createUser(&#123;user:&apos;myuser&apos;,pwd:&apos;123456&apos;,roles:[&#123;role:&apos;dbOwner&apos;,db:&apos;userdb&apos;&#125;]&#125;)</span><br></pre></td></tr></table></figure>
<p>然后关闭服务器，开启认证，重启服务器，用mongovue连接，一切OK </p>
<p><a href="http://21jhf.iteye.com/blog/2216103" target="_blank" rel="external">转载自：http://21jhf.iteye.com/blog/2216103</a></p>

            </div>
        </div>
    </div>
</div>
  </div>
  <div class="footer">
  <p>感谢hexo(https://hexo.io)提供技术支持</p>
  <p>2010-2016</p>
  </div>
  <script src="https://cdn.bootcss.com/jquery/1.12.1/jquery.min.js"></script>
  <script src="https://cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  <script src="https://cdn.rawgit.com/google/code-prettify/master/loader/run_prettify.js"></script>
</body>

</html>
